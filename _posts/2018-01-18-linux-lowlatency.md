---
layout: post
title:  "Оптимизация отзывчивости Linux"
date:   2018-02-01 12:45:00 +0300
categories: Complex
---

Дано: компьютер с Ubuntu Linux 16.04

Цель: увеличить отзывчивость системы


## Устанавливаем ядро с низкими задержками

Устанавливаем пакет linux-lowlatency:

```
$ sudo apt-get install linux-lowlatency
```

В интернетах пишут, что перенастроен планировщик IO и ускорена обработка прерываний. 
Например музыка должна плавно воспроизводиться даже при высокой нагрузке. При 
этом возможно падение пиковой производительности из-за особенностей распределения
ресурсов.

## Отключаем swap

Исключаем вытеснение на диск и подкачку с диска памяти. Тем самым снижая
фризы при пиковых нагрузках IO. Для SSD в качестве бонуса экономим ресурс
количества перезаписи ячеек.

Отключать swap целесообразно если повседневные задачи занимают до 70% памяти.

### Отключаем swap в системе (после перезагрузки система опять его подключит):

```
$ sudo swapoff -a
```

### Отключаем раздел swap:

```
$ sudo vim /etc/fstab
```

Для начала просто закомментировав с помощью *#*

```
# swap was on /dev/sda7 during installation
#UUID=abc12345-6789-0d1e-fg2h-a345b67cd8e9 none            swap    sw              0       0
```

Потом, при желании, можно удалить раздел и использовать освободившееся место
на диске для других целей.

## Оптимизируем кэш VFS

Отключаем вымывание кэша виртуальной файловой системы. Для этого прописываем в
файле /etc/sysctl.conf

```
$ sudo vim /etc/sysctl.conf
```

значение переменной

```
vm.vfs_cache_pressure = 0
```
Значение 0 отключает вымывание кэша, что может сказаться на расходе оперативной
памяти. Я не заметил рост занятой памяти из-за кэша, поэтому 
настроил его постоянное хранение. 

При желании можно просто на порядок уменьшить интенсивность 
освобождения кэша записав значение 10 или 1.

## Включаем кэш записи на диск

Включение кэширования записи на диск ускорит запись мелких файлов.
При этом возможна потеря данных при не штатном завершении заботы компьютера.

Включить кэширование можно утилитой gnome-disks

```
$ gnome-disks
```

В меню диска пункт "Параметры привода...", вкладка "Кэш записи".

## Уменьшаем фрагментацию памяти

Записываем в переменную окружения MALLOC_ARENA_MAX количество
потоков процессора. По умолчанию система использует значение 8 * количество
потоков, что может привести к излишней фрагментации памяти 
[Consider lowering MALLOC_ARENA_MAX to prevent native memory OOM](https://github.com/prestodb/presto/issues/8993)

Для этого в файле /etc/environment

```
$ sudo vim /etc/environment
```

добавляем значение переменной окружения

```
MALLOC_ARENA_MAX=4
```
